const SHEET_ID = "1YEqS1zEf-ej7lfqLIpej6j2YXbAgCES3VC_2ODH721Y";
const FOLDER_ID = "1jJ_1IfvfzyEonA_JzBFI5nu460JGYgHZ";
const SHEET_NAME = "ข้อมูลการมาเรียน";

function doGet(e) {
  const action = e.parameter.action;
  if (action === 'read') {
    return readData();
  }
  return ContentService.createTextOutput(JSON.stringify({status: "error", message: "Invalid GET action"}))
                     .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  try {
    const action = e.parameter.action;
    let response;
    // ใช้ LockService ป้องกันการเขียนข้อมูลพร้อมกัน
    const lock = LockService.getScriptLock();
    lock.waitLock(30000);

    switch (action) {
      case 'create':
        response = createRecord(e.parameter);
        break;
      case 'update':
        response = updateRecord(e.parameter);
        break;
      case 'delete':
        response = deleteRecord(e.parameter);
        break;
      default:
        response = { status: 'error', message: 'Invalid POST action specified.' };
    }
    return ContentService.createTextOutput(JSON.stringify(response))
                       .setMimeType(ContentService.MimeType.JSON);

    lock.releaseLock();
    return ContentService.createTextOutput(JSON.stringify(response))
      .setMimeType(ContentService.MimeType.JSON);
                         
  } catch (error) {
    Logger.log("Error in doPost: " + error.toString() + "\nStack: " + error.stack);
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: error.message, details: error.stack }))
                       .setMimeType(ContentService.MimeType.JSON);
  }
}

function getOrCreateSheet(sheetName) {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  let sheet = ss.getSheetByName(sheetName);
  const expectedHeaders = [
    "RowID", "Timestamp", "Level", "Classroom", "StudentNumber", "StudentID", "FullName", "Nickname", "ProfilePic๊๋JSON",
    "AttendanceDate", "AttendanceType", "AttendanceOccurrence",
    "AbsenceCategory", "AbsenceDetailContinuous", "AbsenceDetailNonContinuous", "LateDetail",
    "FollowUpActions", "FollowUpStatus", "Notes", "DocumentJSON", "ImageJSON"
  ];

  if (!sheet) {
    sheet = ss.insertSheet(sheetName);
  }
  // This logic now runs for both new and existing sheets to guarantee headers
  // Check if sheet is completely empty or header row is missing
  if (sheet.getLastRow() === 0) {
      sheet.appendRow(expectedHeaders);
      sheet.getRange(1, 1, 1, expectedHeaders.length).setFontWeight("bold");
  } else {
      const currentHeaders = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
      if (JSON.stringify(currentHeaders) !== JSON.stringify(expectedHeaders)) {
          // If headers do not match, overwrite them. BE CAREFUL with existing data.
          // For this app, it's safer to assume headers must be correct.
          sheet.getRange(1, 1, 1, expectedHeaders.length).setValues([expectedHeaders]);
          //
          if(currentHeaders.length > expectedHeaders.length) {
              sheet.deleteColumns(expectedHeaders.length + 1, currentHeaders.length - expectedHeaders.length);
          }
      }
  }

  SpreadsheetApp.flush();
  return sheet;
}

function uploadSingleFileToDrive(fileDataString, folderId, isImageForDirectView = false) {
  if (!fileDataString || fileDataString === '{}' || fileDataString === 'null') {
    return null; 
  }
  try {
    const folder = DriveApp.getFolderById(folderId);
    const fileObj = JSON.parse(fileDataString); 
    if (fileObj && fileObj.base64 && fileObj.type && fileObj.name) {
      const decoded = Utilities.base64Decode(fileObj.base64, Utilities.Charset.UTF_8);
      const blob = Utilities.newBlob(decoded, fileObj.type, fileObj.name);
      const file = folder.createFile(blob);
      let fileUrl = file.getUrl();
      if (isImageForDirectView) { 
        file.setSharing(DriveApp.Access.ANYONE, DriveApp.Permission.VIEW); // Use ANYONE for better compatibility
        fileUrl = `https://drive.google.com/uc?export=view&id=${file.getId()}`;
      }
      return JSON.stringify({ name: fileObj.name, url: fileUrl, type: fileObj.type });
    }
    return null;
  } catch (e) {
    Logger.log("Error in uploadSingleFileToDrive: " + e.toString() + " Input: " + fileDataString);
    return null;
  }
}

function createRecord(params) {
  const sheet = getOrCreateSheet(SHEET_NAME);

  const profilePicJSON = uploadSingleFileToDrive(params.profilePicData, FOLDER_ID, true); 
  const documentJSON = uploadSingleFileToDrive(params.documentData, FOLDER_ID, false); 
  const imageJSON = uploadSingleFileToDrive(params.imageData, FOLDER_ID, true);    

  const lastRow = sheet.getLastRow();
  let maxId = 0;
  if (lastRow > 1) {
    const idsDataRange = sheet.getRange(2, 1, Math.max(1, lastRow - 1), 1);
    const idsData = idsDataRange.getValues();
    maxId = idsData.reduce((max, row) => {
      const currentId = parseInt(row[0], 10);
      return !isNaN(currentId) ? Math.max(max, currentId) : max;
    }, 0);
  }
  const newRowId = maxId + 1;

  const newRowData = [
    newRowId, new Date(), params.level, params.classroom, params.studentNumber, params.studentId,
    params.fullName, params.nickname || "", profilePicJSON, 
    params.attendanceDate, params.attendanceType, params.attendanceOccurrence,
    params.absenceCategory || "", params.absenceDetailContinuous || "", params.absenceDetailNonContinuous || "", params.lateDetail || "",
    params.followUpActions || "[]", params.followUpStatus || "ระหว่างดำเนินการ",
    params.notes || "", documentJSON, imageJSON
  ];
  sheet.appendRow(newRowData);
  return { status: 'success', message: 'บันทึกข้อมูลเรียบร้อย', newRowId: newRowId };
}

function readData() {
  const sheet = getOrCreateSheet(SHEET_NAME);
  if (sheet.getLastRow() < 2) {
    return ContentService.createTextOutput(JSON.stringify([])).setMimeType(ContentService.MimeType.JSON);
  }
  const lastCol = sheet.getLastColumn();
  if (lastCol === 0) { 
    return ContentService.createTextOutput(JSON.stringify([])).setMimeType(ContentService.MimeType.JSON);
  }
  const headers = sheet.getRange(1, 1, 1, lastCol).getValues()[0];
  const dataRange = sheet.getRange(2, 1, sheet.getLastRow() - 1, lastCol);
  const data = dataRange.getValues();

  const results = data.map(row => {
    let obj = {};
    headers.forEach((header, index) => {
      let value = row[index];
      if (header === "AttendanceDate" && value instanceof Date) {
        value = Utilities.formatDate(value, Session.getScriptTimeZone(), "yyyy-MM-dd");
      }
      if (["FollowUpActions", "DocumentJSON", "ImageJSON", "ProfilePicJSON"].includes(header)) {
        try {
          if (value && typeof value === 'string') { 
            obj[header] = JSON.parse(value);
          } else { 
            obj[header] = (header === "FollowUpActions" ? [] : null); 
          }
        } catch (e) {
           Logger.log("Error parsing JSON for header " + header + " in rowID " + row[0] + ", value: " + value + ", error: " + e.toString());
          obj[header] = (header === "FollowUpActions" ? [] : null); 
        }
      } else {
        obj[header] = value;
      }
    });
    return obj;
  });
  return ContentService.createTextOutput(JSON.stringify(results)).setMimeType(ContentService.MimeType.JSON);
}

function findRowIndexByRowID(sheet, rowId) {
  if (sheet.getLastRow() < 2) return -1;
  const ids = sheet.getRange(2, 1, sheet.getLastRow() - 1, 1).getValues();
  for (let i = 0; i < ids.length; i++) {
    if (ids[i][0] == rowId) {
      return i + 2;
    }
  }
  return -1;
}

function updateRecord(params) { 
  const sheet = getOrCreateSheet(SHEET_NAME);
  const rowId = parseInt(params.rowId, 10);
  const rowIndexToUpdate = findRowIndexByRowID(sheet, rowId);

  if (rowIndexToUpdate === -1) {
    return { status: 'error', message: 'ไม่พบข้อมูล (Row ID not found)' };
  }
  
  const headersFromSheet = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const setValueByHeader = (headerName, value, defaultValue = "") => {
    const colIndex = headersFromSheet.indexOf(headerName);
    if (colIndex !== -1) {
      sheet.getRange(rowIndexToUpdate, colIndex + 1).setValue(value === undefined || value === null ? defaultValue : value);
    } else {
        // Logger.log("Header not found for update: " + headerName);
    }
  };

  setValueByHeader("Level", params.level); 
  setValueByHeader("Classroom", params.classroom); 
  setValueByHeader("StudentNumber", params.studentNumber); 
  setValueByHeader("StudentID", params.studentId); 
  setValueByHeader("FullName", params.fullName); 
  setValueByHeader("Nickname", params.nickname || ""); 
  
  setValueByHeader("AttendanceDate", params.attendanceDate);
  setValueByHeader("AttendanceType", params.attendanceType);
  setValueByHeader("AttendanceOccurrence", params.attendanceOccurrence);
  setValueByHeader("AbsenceCategory", params.absenceCategory || "");
  setValueByHeader("AbsenceDetailContinuous", params.absenceDetailContinuous || "");
  setValueByHeader("AbsenceDetailNonContinuous", params.absenceDetailNonContinuous || "");
  setValueByHeader("LateDetail", params.lateDetail || "");
  setValueByHeader("FollowUpActions", params.followUpActions || "[]");
  setValueByHeader("FollowUpStatus", params.followUpStatus || "ระหว่างดำเนินการ");
  setValueByHeader("Notes", params.notes || "");
  
  // ProfilePicJSON, DocumentJSON, ImageJSON are not updated in this function
  // as it would require handling new file uploads within the edit modal.

  return { status: 'success', message: 'อัปเดตข้อมูลเรียบร้อย' };
}

function deleteRecord(params) {
  const sheet = getOrCreateSheet(SHEET_NAME);
  const rowId = parseInt(params.rowId, 10);
  const rowIndexToDelete = findRowIndexByRowID(sheet, rowId);

  if (rowIndexToDelete !== -1) {
    sheet.deleteRow(rowIndexToDelete);
    return { status: 'success', message: 'ลบข้อมูลเรียบร้อย' };
  } else {
    return { status: 'error', message: 'ไม่พบข้อมูล (Row ID not found)' };
  }
}
