<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกข้อมูลการมาโรงเรียน</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --primary-color: #4A148C; /* ม่วงเข้ม */
            --secondary-color: #CE93D8; /* ม่วงอ่อนใช้เป็น accent */
            --light-purple-bg: #f3e5f5; /* ม่วงอ่อนมากสำหรับพื้นหลังบางส่วน */
            --light-color: #FFFFFF;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --header-font-size: 2.2em;
            --subheader-font-size: 1.4em;
        }
        body { font-family: 'Sarabun', 'Kanit', sans-serif; margin: 0; background-color: #f9f8fc; color: var(--text-color); line-height: 1.6; }
        .container { max-width: 1300px; margin: auto; padding: 20px; }
        header { background: linear-gradient(135deg, var(--primary-color) 0%, #6A1B9A 100%); color: var(--light-color); padding: 25px 20px; text-align: center; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; box-shadow: 0 6px 12px rgba(74, 20, 140, 0.2); }
        header h1 { font-size: var(--header-font-size); font-weight: 700; margin: 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        header h2 { font-size: var(--subheader-font-size); font-weight: 400; margin: 10px 0 0 0; opacity: 0.9; }
        nav { display: flex; justify-content: center; background-color: var(--light-color); padding: 5px 0; box-shadow: 0 3px 6px rgba(0,0,0,0.1); margin-top: 25px; border-radius: 12px; flex-wrap: wrap; }
        .nav-button { background-color: transparent; color: var(--primary-color); border: none; padding: 15px 20px; cursor: pointer; font-size: 1.05em; font-weight: 600; transition: background-color 0.3s, color 0.3s, border-bottom-color 0.3s; border-bottom: 4px solid transparent; letter-spacing: 0.5px; }
        .nav-button:hover, .nav-button.active { background-color: var(--light-purple-bg); color: #38006b; border-bottom-color: var(--primary-color); }
        .page { display: none; margin-top: 25px; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .page.active { display: block; }
        .card { background-color: var(--light-color); border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.07); padding: 30px; margin-bottom: 25px; }
        .card h3 { color: var(--primary-color); border-bottom: 2px solid var(--secondary-color); padding-bottom: 12px; margin-top: 0; margin-bottom: 20px; font-size: 1.5em; display: flex; align-items: center; gap: 10px;}
        .form-group { margin-bottom: 22px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #444; font-size: 0.95em; }
        .form-control, select, textarea { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1em; box-sizing: border-box; transition: border-color 0.3s, box-shadow 0.3s; background-color: #fdfdfd; }
        .form-control:focus, select:focus, textarea:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(74, 20, 140, 0.15); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px 25px; }
        .btn { padding: 12px 28px; font-size: 1.05em; border-radius: 8px; cursor: pointer; border: none; font-weight: 600; transition: all 0.25s ease-out; display: inline-flex; align-items: center; justify-content: center; gap: 8px; letter-spacing: 0.5px; text-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .btn-primary { background: linear-gradient(135deg, var(--primary-color), #7b1fa2); color: var(--light-color); }
        .btn-secondary { background: linear-gradient(135deg, #ab47bc, var(--secondary-color)); color: var(--light-color); }
        .btn-success { background: linear-gradient(135deg, #43A047, #66BB6A); color: var(--light-color); }
        .btn-danger { background: linear-gradient(135deg, #E53935, #EF5350); color: var(--light-color); }
        .table-container { overflow-x: auto; background-color: var(--light-color); padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 14px; text-align: left; border-bottom: 1px solid #f0f0f0; vertical-align: middle; font-size: 0.95em; }
        thead { background-color: var(--light-purple-bg); }
        th { font-weight: 600; color: var(--primary-color); text-transform: uppercase; font-size: 0.85em; letter-spacing: 0.5px;}
        tbody tr:hover { background-color: #fdf5ff; }
        .hidden { display: none !important; }
        #recommendation-box { background-color: var(--light-purple-bg); border-left: 5px solid var(--primary-color); padding: 15px; margin-top: 20px; border-radius: 8px; font-size: 0.95em;}
        .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; }
        .checkbox-item { display: flex; align-items: center; background-color: #fdfdfd; padding: 10px; border-radius: 6px; border: 1px solid #eee; }
        .checkbox-item input[type="checkbox"] { margin-right: 12px; width: 18px; height: 18px; accent-color: var(--primary-color); }
        .search-filters { display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; padding: 20px; background-color: var(--light-purple-bg); border-radius: 8px; margin-bottom: 20px;}
        .search-filters .form-group { margin-bottom: 0;}
        .swal2-html-container { text-align: left !important; font-size: 1em !important; }
        .swal2-input, .swal2-select, .swal2-textarea { font-size: 1em !important; border-radius: 6px !important; }
        .swal2-actions button { font-size: 1em !important; padding: 10px 20px !important; margin: 5px !important; }
        @media (max-width: 768px) {
            .nav-button { flex-grow: 1; text-align: center; font-size: 0.95em; padding: 12px 15px;}
            .form-grid { grid-template-columns: 1fr; }
            header h1 { font-size: 1.8em; }
            header h2 { font-size: 1.2em; }
            .card h3 { font-size: 1.3em; }
            .btn { padding: 10px 20px; font-size: 0.95em;}
        }
    </style>
</head>
<body>

    <header>
        <h1><i class="fas fa-user-check"></i> บันทึกข้อมูลการมาโรงเรียนของนักเรียน</h1>
        <h2>โรงเรียนมาบตาพุดพันพิทยาคาร</h2>
    </header>

    <div class="container">
        <nav>
            <button class="nav-button active" onclick="showPage('page-form')"><i class="fas fa-edit"></i> บันทึกข้อมูล</button>
            <button class="nav-button" onclick="showPage('page-individual')"><i class="fas fa-user-search"></i> ข้อมูลรายบุคคล</button>
            <button class="nav-button" onclick="showPage('page-summary')"><i class="fas fa-list-alt"></i> สรุปข้อมูลรวม</button>
            <button class="nav-button" onclick="showPage('page-stats')"><i class="fas fa-chart-bar"></i> สถิติ</button>
        </nav>

        <div id="page-form" class="page active">
            <form id="attendanceForm">
                <div class="card">
                    <h3><i class="fas fa-user-graduate"></i> ข้อมูลนักเรียน</h3>
                    <div class="form-grid">
                        <div class="form-group"><label for="level">ระดับชั้น</label><select id="level" class="form-control" required></select></div>
                        <div class="form-group"><label for="classroom">ห้องเรียน</label><select id="classroom" class="form-control" required></select></div>
                        <div class="form-group"><label for="studentNumber">เลขที่</label><select id="studentNumber" class="form-control" required></select></div>
                        <div class="form-group"><label for="studentId">รหัสประจำตัวนักเรียน</label><input type="text" id="studentId" class="form-control" required></div>
                        <div class="form-group"><label for="fullName">ชื่อ-สกุล</label><input type="text" id="fullName" class="form-control" required></div>
                        <div class="form-group"><label for="nickname">ชื่อเล่น</label><input type="text" id="nickname" class="form-control"></div>
                    </div>
                </div>

                <div class="card">
                    <h3><i class="fas fa-calendar-check"></i> ข้อมูลการมาโรงเรียน</h3>
                    <div class="form-grid">
                        <div class="form-group"><label for="attendanceDate">วันที่บันทึก</label><input type="date" id="attendanceDate" class="form-control" required></div>
                        <div class="form-group"><label for="attendanceType">ประเภท</label><select id="attendanceType" class="form-control" required><option value="">-- เลือกประเภท --</option><option value="การขาดเรียน">การขาดเรียน</option><option value="การมาสาย">การมาสาย</option></select></div>
                        <div class="form-group"><label for="attendanceOccurrence">ครั้งที่ (สะสม)</label><select id="attendanceOccurrence" class="form-control" required></select></div>
                    </div>

                    <div id="absence-options" class="hidden">
                        <div class="form-group"><label for="absenceCategory">หมวดหมู่การขาดเรียน</label><select id="absenceCategory" class="form-control"><option value="">-- เลือกหมวดหมู่ --</option><option value="ขาดเรียนต่อเนื่อง(รอบ1เดือน)">ขาดเรียนต่อเนื่อง(รอบ1เดือน)</option><option value="ขาดเรียนไม่ต่อเนื่อง(รอบ1เดือน)">ขาดเรียนไม่ต่อเนื่อง(รอบ1เดือน)</option></select></div>
                        <div id="absence-continuous-options" class="form-group hidden"><label for="absenceDetailContinuous">รายละเอียดการขาดต่อเนื่อง</label><select id="absenceDetailContinuous" class="form-control"><option value="">-- เลือก --</option><option value="ขาดติดต่อกัน เกิน 3 วัน">ขาดติดต่อกัน เกิน 3 วัน</option><option value="ขาดติดต่อกันเกิน 5 วัน">ขาดติดต่อกันเกิน 5 วัน</option><option value="ขาดติดต่อกันเกิน 7 วัน">ขาดติดต่อกันเกิน 7 วัน</option><option value="ขาดติดต่อกันเกิน 9 วัน">ขาดติดต่อกันเกิน 9 วัน</option></select></div>
                        <div id="absence-noncontinuous-options" class="form-group hidden"><label for="absenceDetailNonContinuous">รายละเอียดการขาดไม่ต่อเนื่อง</label><select id="absenceDetailNonContinuous" class="form-control"><option value="">-- เลือก --</option><option value="ขาดเรียน 5 วันไม่ต่อเนื่อง">ขาดเรียน 5 วันไม่ต่อเนื่อง</option><option value="ขาดเรียน 7 วันไม่ต่อเนื่อง">ขาดเรียน 7 วันไม่ต่อเนื่อง</option><option value="ขาดเรียน 9 วันไม่ต่อเนื่อง">ขาดเรียน 9 วันไม่ต่อเนื่อง</option></select></div>
                    </div>
                    <div id="late-options" class="form-group hidden">
                        <label for="lateDetail">รายละเอียดการมาสาย</label><select id="lateDetail" class="form-control"><option value="">-- เลือก --</option><option value="มาสาย 5 ครั้ง">มาสาย 5 ครั้ง</option></select>
                    </div>

                    <div class="form-group">
                        <label>ผลการติดตาม (เลือกได้หลายข้อ)</label>
                        <div id="followUpActions" class="checkbox-grid"></div>
                    </div>
                    <div class="form-group"><label for="notes">หมายเหตุเพิ่มเติม</label><textarea id="notes" class="form-control" rows="3" placeholder="รายละเอียดเพิ่มเติม..."></textarea></div>
                    <div id="recommendation-box" class="hidden"></div>
                </div>

                <div class="card">
                    <h3><i class="fas fa-paperclip"></i> แนบไฟล์ (สูงสุดประเภทละ 3 ไฟล์)</h3>
                    <div class="form-grid">
                        <div class="form-group"><label for="docFile1">เอกสาร 1</label><input type="file" id="docFile1" name="docFiles" class="form-control" accept=".pdf,.doc,.docx"></div>
                        <div class="form-group"><label for="docFile2">เอกสาร 2</label><input type="file" id="docFile2" name="docFiles" class="form-control" accept=".pdf,.doc,.docx"></div>
                        <div class="form-group"><label for="docFile3">เอกสาร 3</label><input type="file" id="docFile3" name="docFiles" class="form-control" accept=".pdf,.doc,.docx"></div>
                        <div class="form-group"><label for="imgFile1">รูปภาพ 1</label><input type="file" id="imgFile1" name="imgFiles" class="form-control" accept="image/*"></div>
                        <div class="form-group"><label for="imgFile2">รูปภาพ 2</label><input type="file" id="imgFile2" name="imgFiles" class="form-control" accept="image/*"></div>
                        <div class="form-group"><label for="imgFile3">รูปภาพ 3</label><input type="file" id="imgFile3" name="imgFiles" class="form-control" accept="image/*"></div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> บันทึกข้อมูล</button>
            </form>
        </div>

        <div id="page-individual" class="page">
            <div class="card">
                <h3><i class="fas fa-user-cog"></i> ค้นหาและจัดการข้อมูลนักเรียนรายบุคคล</h3>
                <div class="search-filters">
                    <div class="form-group">
                        <label for="individual-search-type">ค้นหาจาก:</label>
                        <select id="individual-search-type" class="form-control">
                            <option value="FullName">ชื่อ-สกุล</option>
                            <option value="Nickname">ชื่อเล่น</option>
                            <option value="StudentID">รหัสประจำตัว</option>
                        </select>
                    </div>
                     <div class="form-group">
                        <label for="individual-search-keyword">คำค้นหา:</label>
                        <input type="text" id="individual-search-keyword" class="form-control" placeholder="ป้อนคำค้นหา...">
                    </div>
                    <button id="individual-search-btn" class="btn btn-secondary"><i class="fas fa-search"></i> ค้นหา</button>
                    <a href="https://docs.google.com/spreadsheets/d/1YEqS1zEf-ej7lfqLIpej6j2YXbAgCES3VC_2ODH721Y" target="_blank" class="btn btn-success"><i class="fab fa-google-drive"></i> เปิด Google Sheet</a>
                </div>
                <div class="table-container">
                    <table id="individual-table">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="page-summary" class="page">
             <div class="card">
                <h3><i class="fas fa-clipboard-list"></i> สรุปข้อมูลการมาโรงเรียนทั้งหมด</h3>
                <div class="search-filters" id="summary-filters-container">
                    <div class="form-group">
                        <label for="summary-filter-type">กรองข้อมูลโดย:</label>
                        <select id="summary-filter-type" class="form-control"></select>
                    </div>
                    <div id="summary-filter-input-container" class="form-group"></div>
                    <button id="summary-filter-btn" class="btn btn-secondary"><i class="fas fa-filter"></i> กรองข้อมูล</button>
                </div>
                 <a href="https://docs.google.com/spreadsheets/d/1YEqS1zEf-ej7lfqLIpej6j2YXbAgCES3VC_2ODH721Y" target="_blank" class="btn btn-success" style="margin-top: 10px;"><i class="fab fa-google-drive"></i> เปิด Google Sheet</a>
                <div class="table-container">
                    <table id="summary-table">
                         <thead></thead>
                         <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="page-stats" class="page">
            <div class="card">
                <h3><i class="fas fa-chart-line"></i> สถิติและข้อมูลเชิงลึก</h3>
                 <div class="form-group">
                    <label for="stats-filter">เลือกรูปแบบการแสดงผลสถิติ</label>
                    <select id="stats-filter" class="form-control"></select>
                </div>
                <div id="stats-filter-options-container" class="form-grid"></div>
                <div id="charts-wrapper" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <script>
        // --- Global Variables & Constants ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz_OTqN0ng9kZwEguZiDk8gVmsyRxsCBXrc_Zr6OCoA89OOa_cA2dCuQKHd7L5QSiKj9A/exec";
        let allData = [];
        let charts = {}; // To keep track of chart instances for updates/destruction
        const followUpOptions = [
            "ครูที่ปรึกษาติดตาม", "ปค.6 ติดตามการขาดเรียน", "ปค.6/1 รายงานผลการติดตามขาดเรียน", "ปค.5 ติดตามการมาสาย", 
            "ปค.5/1 รายงานติดตามการมาสาย", "ปค.3 เชิญผู้ปกครอง", "แขวนลอย", "ทัณฑ์บน", "บันทึกข้อตกลง", "พฐ.17 (ม.ต้น)", "อื่น ๆ"
        ];
        const recommendations = {
            "ขาดติดต่อกัน เกิน 3 วัน": "ติดตามและบันทึกแบบ ปค.6", "ขาดติดต่อกันเกิน 5 วัน": "ติดตามและบันทึกแบบ ปค.6 และ ปค.6/1",
            "ขาดติดต่อกันเกิน 7 วัน": "ติดตามและบันทึกแบบ ปค.6 และ ปค.6/1 (ม.ต้น พฐ.17)", "ขาดติดต่อกันเกิน 9 วัน": "ส่งข้อมูลกับวิชาการเพื่อแขวนลอย/ปรับเปลี่ยนสภาพแวดล้อม",
            "ขาดเรียน 5 วันไม่ต่อเนื่อง": "ติดตามและบันทึกแบบ ปค.6", "ขาดเรียน 7 วันไม่ต่อเนื่อง": "ติดตามและบันทึกแบบ ปค.6 และ ปค.6/1 (ม.ต้น พฐ.17)",
            "ขาดเรียน 9 วันไม่ต่อเนื่อง": "ส่งข้อมูลกับวิชาการเพื่อแขวนลอย/ปรับเปลี่ยนสภาพแวดล้อม", "มาสาย 5 ครั้ง": "ติดตามและบันทึกแบบ ปค.5 เชิญประชุมผปค. และ รายงาน ปค.5/1 (หากบันทึกครบ 3 ครั้ง ให้ทำทัณฑ์บน)"
        };
        const CHART_COLORS = ['#4A148C', '#7B1FA2', '#9C27B0', '#BA68C8', '#CE93D8', '#6A1B9A', '#AB47BC', '#E1BEE7', '#8E24AA', '#673AB7', '#512DA8', '#D1C4E9'];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            populateStaticDropdowns();
            setupEventListeners();
            fetchAllData().then(() => {
                // Initial render for pages that might be active or need data
                if (document.getElementById('page-summary').classList.contains('active')) {
                    applySummaryFilters(); // Render summary table with "all" filter initially
                }
                setupStatsPageControls(); // Setup stats page filters and initial chart
            });
        });

        function populateStaticDropdowns() {
            const populate = (elId, start, end, formatFn, addEmptyOption = false) => {
                const el = document.getElementById(elId);
                if (!el) { console.error("Element not found:", elId); return; }
                el.innerHTML = addEmptyOption ? '<option value="">-- เลือก --</option>' : '';
                for (let i = start; i <= end; i++) el.innerHTML += formatFn(i);
            };
            populate('level', 1, 6, i => `<option value="ม.${i}">ม.${i}</option>`);
            populate('classroom', 1, 18, i => `<option value="${i}">ห้อง ${i}</option>`);
            populate('studentNumber', 1, 50, i => `<option value="${i}">${i}</option>`);
            populate('attendanceOccurrence', 1, 20, i => `<option value="ครั้งที่ ${i}">ครั้งที่ ${i}</option>`);

            const followUpContainer = document.getElementById('followUpActions');
            followUpOptions.forEach(opt => {
                const id = `follow-${opt.replace(/[^a-zA-Z0-9]/g, "")}`; // Create a valid ID
                followUpContainer.innerHTML += `
                    <div class="checkbox-item">
                        <input type="checkbox" id="${id}" name="followUp" value="${opt}">
                        <label for="${id}">${opt}</label>
                    </div>`;
            });
            
            document.getElementById('attendanceDate').valueAsDate = new Date(); // Default to today
            setupSummaryPageFilters();
        }

        function setupEventListeners() {
            document.querySelectorAll('.nav-button').forEach(btn => btn.addEventListener('click', (e) => {
                 document.querySelector('.nav-button.active').classList.remove('active');
                 e.currentTarget.classList.add('active');
                 if(e.currentTarget.getAttribute('onclick') === "showPage('page-summary')") {
                     applySummaryFilters(); // Re-filter/render when navigating to summary
                 } else if (e.currentTarget.getAttribute('onclick') === "showPage('page-stats')") {
                     handleStatsFilterChange(); // Re-render charts when navigating to stats
                 }
            }));

            document.getElementById('attendanceForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('attendanceType').addEventListener('change', handleAttendanceTypeChange);
            document.getElementById('absenceCategory').addEventListener('change', handleAbsenceCategoryChange);
            document.getElementById('absenceDetailContinuous').addEventListener('change', (e) => updateRecommendations(e.target.value));
            document.getElementById('absenceDetailNonContinuous').addEventListener('change', (e) => updateRecommendations(e.target.value));
            document.getElementById('lateDetail').addEventListener('change', (e) => updateRecommendations(e.target.value));

            document.getElementById('individual-search-btn').addEventListener('click', renderIndividualTable);
            
            document.getElementById('summary-filter-btn').addEventListener('click', applySummaryFilters);
            document.getElementById('summary-filter-type').addEventListener('change', setupSummaryPageFilters);

            document.getElementById('stats-filter').addEventListener('change', handleStatsFilterChange);
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const newPage = document.getElementById(pageId);
            if (newPage) newPage.classList.add('active');
        }

        async function fetchAllData() {
            Swal.fire({ title: 'กำลังโหลดข้อมูล...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            try {
                const response = await fetch(`${SCRIPT_URL}?action=read`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                allData = await response.json();
                allData.sort((a,b) => new Date(b.AttendanceDate) - new Date(a.AttendanceDate)); // Sort by most recent
                Swal.close();
            } catch(error) {
                console.error("Fetch Error:", error);
                Swal.fire('ผิดพลาด!', 'ไม่สามารถดึงข้อมูลได้: ' + error.message, 'error');
                allData = [];
            }
        }

        // --- Page 1: Form Logic ---
        function handleAttendanceTypeChange(e) {
            const type = e.target.value;
            document.getElementById('absence-options').classList.toggle('hidden', type !== 'การขาดเรียน');
            document.getElementById('late-options').classList.toggle('hidden', type !== 'การมาสาย');
            document.getElementById('absenceCategory').value = ""; // Reset dependent dropdown
            handleAbsenceCategoryChange({target: {value: ""}}); // Trigger its change to reset further
            updateRecommendations("");
        }
        
        function handleAbsenceCategoryChange(e) {
            const category = e.target.value;
            document.getElementById('absence-continuous-options').classList.toggle('hidden', category !== 'ขาดเรียนต่อเนื่อง(รอบ1เดือน)');
            document.getElementById('absence-noncontinuous-options').classList.toggle('hidden', category !== 'ขาดเรียนไม่ต่อเนื่อง(รอบ1เดือน)');
             // Reset detail dropdowns
            document.getElementById('absenceDetailContinuous').value = "";
            document.getElementById('absenceDetailNonContinuous').value = "";
            updateRecommendations("");
        }

        function updateRecommendations(key) {
            const box = document.getElementById('recommendation-box');
            if (key && recommendations[key]) {
                box.innerHTML = `<strong><i class="fas fa-info-circle"></i> คำแนะนำ:</strong> ${recommendations[key]}`;
                box.classList.remove('hidden');
            } else {
                box.classList.add('hidden');
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            Swal.fire({ title: 'กำลังบันทึกข้อมูล...', text: 'กรุณารอสักครู่', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            const fileToBase64 = file => new Promise((resolve, reject) => {
                if (!file) { resolve(null); return; } // Resolve with null if no file
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve({ base64: reader.result.split(',')[1], type: file.type, name: file.name });
                reader.onerror = error => reject(error);
            });

            const form = e.target;
            const docFilesInputs = [form.docFile1, form.docFile2, form.docFile3];
            const imgFilesInputs = [form.imgFile1, form.imgFile2, form.imgFile3];

            const docPromises = docFilesInputs.map(input => fileToBase64(input.files[0]));
            const imgPromises = imgFilesInputs.map(input => fileToBase64(input.files[0]));
            
            const [documentsDataArray, imagesDataArray] = await Promise.all([ Promise.all(docPromises), Promise.all(imgPromises) ]);

            const selectedFollowUps = Array.from(form.querySelectorAll('input[name="followUp"]:checked')).map(cb => cb.value);

            const params = new URLSearchParams({
                action: 'create',
                level: form.level.value, classroom: form.classroom.value, studentNumber: form.studentNumber.value,
                studentId: form.studentId.value, fullName: form.fullName.value, nickname: form.nickname.value,
                attendanceDate: form.attendanceDate.value, attendanceType: form.attendanceType.value,
                attendanceOccurrence: form.attendanceOccurrence.value,
                absenceCategory: form.attendanceType.value === 'การขาดเรียน' ? form.absenceCategory.value : "",
                absenceDetailContinuous: (form.attendanceType.value === 'การขาดเรียน' && form.absenceCategory.value === 'ขาดเรียนต่อเนื่อง(รอบ1เดือน)') ? form.absenceDetailContinuous.value : "",
                absenceDetailNonContinuous: (form.attendanceType.value === 'การขาดเรียน' && form.absenceCategory.value === 'ขาดเรียนไม่ต่อเนื่อง(รอบ1เดือน)') ? form.absenceDetailNonContinuous.value : "",
                lateDetail: form.attendanceType.value === 'การมาสาย' ? form.lateDetail.value : "",
                followUpActions: JSON.stringify(selectedFollowUps),
                notes: form.notes.value,
                documentsData: JSON.stringify(documentsDataArray.filter(d => d)), // Filter out nulls before stringifying
                imagesData: JSON.stringify(imagesDataArray.filter(i => i))      // Filter out nulls
            });

            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: params });
                const result = await res.json();
                if (result.status === 'success') {
                    Swal.fire('สำเร็จ!', 'บันทึกข้อมูลเรียบร้อย', 'success');
                    form.reset();
                    document.getElementById('attendanceDate').valueAsDate = new Date();
                    handleAttendanceTypeChange({target: {value: ""}}); // Reset conditional fields
                    allData = [];
                    fetchAllData();
                } else { throw new Error(result.message || 'Error saving data'); }
            } catch (error) {
                console.error("Submit Error:", error);
                Swal.fire('ผิดพลาด!', 'เกิดข้อผิดพลาด: ' + error.message, 'error');
            }
        }
        
        // --- Generic Functions (Edit, Delete, Modal for Files) ---
        function showFilesModal(filesJson, type) { // filesJson is already an array here from GAS response
            const files = (typeof filesJson === 'string') ? JSON.parse(filesJson || "[]") : (filesJson || []);
            if (!files || files.length === 0) {
                Swal.fire('ไม่มีไฟล์', `ไม่พบไฟล์${type === 'images' ? 'รูปภาพ' : 'เอกสาร'}สำหรับรายการนี้`, 'info'); return;
            }
            let content = '<div style="max-height: 400px; overflow-y: auto;">';
            if (type === 'images') {
                files.forEach(file => { content += `<div style="margin-bottom: 15px; text-align: center;"><a href="${file.url}" target="_blank">${file.name}</a><br><img src="${file.url}" style="max-width: 100%; max-height:300px; height: auto; margin-top: 5px; border-radius: 5px;"></div>`; });
            } else {
                files.forEach(file => { content += `<p style="text-align: center;"><a href="${file.url}" target="_blank" class="btn btn-primary btn-sm"><i class="fas fa-download"></i> ${file.name}</a></p>`; });
            }
            content += '</div>';
            Swal.fire({ title: `ไฟล์${type === 'images' ? 'รูปภาพ' : 'เอกสาร'}`, html: content, width: '80%' });
        }
        
        async function editRecord(rowId) {
            const rowData = allData.find(r => r.RowID == rowId);
            if (!rowData) { Swal.fire('ผิดพลาด', 'ไม่พบข้อมูล', 'error'); return; }

            const modalHtml = `
                <div style="text-align:left;">
                    <div class="card" style="box-shadow: none; padding:0; margin-bottom:15px;">
                        <h4><i class="fas fa-user-graduate"></i> ข้อมูลนักเรียน (ไม่สามารถแก้ไขได้ที่นี่)</h4>
                        <p><strong>ระดับชั้น:</strong> ${rowData.Level} <strong>ห้อง:</strong> ${rowData.Classroom} <strong>เลขที่:</strong> ${rowData.StudentNumber}</p>
                        <p><strong>ชื่อ-สกุล:</strong> ${rowData.FullName} (${rowData.Nickname || '-'})</p>
                        <p><strong>รหัสประจำตัว:</strong> ${rowData.StudentID}</p>
                    </div>
                    <hr>
                    <h4><i class="fas fa-calendar-check"></i> แก้ไขข้อมูลการมาโรงเรียน</h4>
                    <div class="form-grid">
                        <div class="form-group"><label>วันที่บันทึก</label><input id="swal-attendanceDate" type="date" class="form-control" value="${rowData.AttendanceDate}"></div>
                        <div class="form-group"><label>ประเภท</label><select id="swal-attendanceType" class="form-control"><option value="การขาดเรียน">การขาดเรียน</option><option value="การมาสาย">การมาสาย</option></select></div>
                        <div class="form-group"><label>ครั้งที่ (สะสม)</label><select id="swal-attendanceOccurrence" class="form-control"></select></div>
                    </div>
                    <div class="form-group"><label>ผลการติดตาม</label><div id="swal-followUpActions" class="checkbox-grid"></div></div>
                    <div class="form-group"><label>หมายเหตุ</label><textarea id="swal-notes" class="form-control" rows="3">${rowData.Notes || ''}</textarea></div>
                </div>`;
            
            const { value: formValues } = await Swal.fire({
                title: 'แก้ไขข้อมูลการมาโรงเรียน', html: modalHtml, width: '90%', showCancelButton: true,
                confirmButtonText: '<i class="fas fa-save"></i> บันทึกการแก้ไข', cancelButtonText: 'ยกเลิก',
                didOpen: () => {
                    const populateSwalDropdown = (elId, start, end, formatFn, val) => { const el = document.getElementById(elId); el.innerHTML = ''; for (let i = start; i <= end; i++) el.innerHTML += formatFn(i); el.value = val; };
                    populateSwalDropdown('swal-attendanceOccurrence', 1, 20, i => `<option value="ครั้งที่ ${i}">ครั้งที่ ${i}</option>`, rowData.AttendanceOccurrence);
                    document.getElementById('swal-attendanceType').value = rowData.AttendanceType;

                    const swalFollowUpContainer = document.getElementById('swal-followUpActions');
                    const currentFollowUps = Array.isArray(rowData.FollowUpActions) ? rowData.FollowUpActions : [];
                    followUpOptions.forEach(opt => {
                        const checked = currentFollowUps.includes(opt) ? 'checked' : '';
                        const id = `swal-follow-${opt.replace(/[^a-zA-Z0-9]/g, "")}`;
                        swalFollowUpContainer.innerHTML += `<div class="checkbox-item"><input type="checkbox" id="${id}" name="swalFollowUp" value="${opt}" ${checked}><label for="${id}">${opt}</label></div>`;
                    });
                },
                preConfirm: () => {
                    const selectedFollowUps = Array.from(document.querySelectorAll('input[name="swalFollowUp"]:checked')).map(cb => cb.value);
                    return {
                        // Student info passed through but not directly editable in this simplified modal
                        level: rowData.Level, classroom: rowData.Classroom, studentNumber: rowData.StudentNumber,
                        studentId: rowData.StudentID, fullName: rowData.FullName, nickname: rowData.Nickname,
                        // Editable attendance info
                        attendanceDate: document.getElementById('swal-attendanceDate').value, 
                        attendanceType: document.getElementById('swal-attendanceType').value,
                        attendanceOccurrence: document.getElementById('swal-attendanceOccurrence').value,
                        followUpActions: JSON.stringify(selectedFollowUps), 
                        notes: document.getElementById('swal-notes').value,
                        // Keep original absence/late details as this modal does not edit them
                        absenceCategory: rowData.AbsenceCategory, 
                        absenceDetailContinuous: rowData.AbsenceDetailContinuous,
                        absenceDetailNonContinuous: rowData.AbsenceDetailNonContinuous, 
                        lateDetail: rowData.LateDetail
                    }
                }
            });

            if (formValues) {
                Swal.fire({ title: 'กำลังอัปเดต...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                const params = new URLSearchParams({ action: 'updateAttendance', rowId, ...formValues });
                fetch(SCRIPT_URL, { method: 'POST', body: params })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'success') {
                            Swal.fire('สำเร็จ!', data.message, 'success');
                            allData = []; fetchAllData().then(() => {
                                if (document.getElementById('page-individual').classList.contains('active')) renderIndividualTable(); // Re-filter if needed
                                if (document.getElementById('page-summary').classList.contains('active')) applySummaryFilters();
                            });
                        } else { throw new Error(data.message); }
                    })
                    .catch(error => Swal.fire('ผิดพลาด!', "เกิดข้อผิดพลาด: " + error.message, 'error'));
            }
        }

        function deleteRecord(rowId) {
             Swal.fire({
                title: 'คุณแน่ใจหรือไม่?', text: "ข้อมูลนี้จะถูกลบอย่างถาวร!", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6',
                confirmButtonText: 'ใช่, ลบเลย!', cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({ title: 'กำลังลบ...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                    const params = new URLSearchParams({ action: 'delete', rowId: rowId });
                    fetch(SCRIPT_URL, { method: 'POST', body: params })
                        .then(res => res.json())
                        .then(data => {
                            if (data.status === 'success') {
                                Swal.fire('ลบแล้ว!', data.message, 'success');
                                allData = []; fetchAllData().then(() => {
                                    if (document.getElementById('page-individual').classList.contains('active')) renderIndividualTable(); // Re-filter
                                    if (document.getElementById('page-summary').classList.contains('active')) applySummaryFilters();
                                });
                            } else { throw new Error(data.message); }
                        })
                        .catch(error => Swal.fire('ผิดพลาด!', "เกิดข้อผิดพลาด: " + error.message, 'error'));
                }
            });
        }

        // --- Page 2: Individual Logic ---
        function renderIndividualTable() {
            const searchType = document.getElementById('individual-search-type').value;
            const keyword = document.getElementById('individual-search-keyword').value.trim().toLowerCase();
            if (!keyword && allData.length > 0) { Swal.fire('โปรดทราบ', 'กรุณาป้อนคำค้นหาสำหรับนักเรียน', 'info'); document.getElementById('individual-table').querySelector('tbody').innerHTML = `<tr><td colspan="7" style="text-align: center;">กรุณาป้อนคำค้นหา</td></tr>`; return; }
            
            const filteredData = allData.filter(row => (row[searchType] || "").toLowerCase().includes(keyword));
            
            const table = document.getElementById('individual-table'), thead = table.querySelector('thead'), tbody = table.querySelector('tbody');
            thead.innerHTML = `<tr><th>วันที่</th><th>ประเภท</th><th>ครั้งที่</th><th>รายละเอียด</th><th>ผลการติดตาม</th><th>ไฟล์แนบ</th><th>จัดการ</th></tr>`;
            tbody.innerHTML = '';
            if (filteredData.length === 0) { tbody.innerHTML = `<tr><td colspan="7" style="text-align: center;">ไม่พบข้อมูล${keyword ? `ของ '${document.getElementById('individual-search-keyword').value}'` : ''}</td></tr>`; return; }

            filteredData.forEach(row => {
                let detail = row.AbsenceDetailContinuous || row.AbsenceDetailNonContinuous || row.LateDetail || '-';
                let followUps = Array.isArray(row.FollowUpActions) && row.FollowUpActions.length > 0 ? row.FollowUpActions.join(', ') : '-';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.AttendanceDate}</td><td>${row.AttendanceType}</td><td>${row.AttendanceOccurrence}</td><td>${detail}</td><td>${followUps}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" style="padding: 5px 8px;" onclick='showFilesModal(${JSON.stringify(row.ImagesJSON)}, "images")' ${!row.ImagesJSON || row.ImagesJSON.length === 0 ? 'disabled' : ''}><i class="fas fa-image"></i></button>
                        <button class="btn btn-primary btn-sm" style="padding: 5px 8px;" onclick='showFilesModal(${JSON.stringify(row.DocumentsJSON)}, "docs")' ${!row.DocumentsJSON || row.DocumentsJSON.length === 0 ? 'disabled' : ''}><i class="fas fa-file-alt"></i></button>
                    </td>
                    <td><button class="btn btn-secondary btn-sm" style="padding: 5px 8px;" onclick="editRecord(${row.RowID})"><i class="fas fa-edit"></i></button> <button class="btn btn-danger btn-sm" style="padding: 5px 8px;" onclick="deleteRecord(${row.RowID})"><i class="fas fa-trash"></i></button></td>`;
                tbody.appendChild(tr);
            });
        }
        
        // --- Page 3: Summary Logic ---
        function setupSummaryPageFilters() {
            const filterTypeEl = document.getElementById('summary-filter-type');
            if(filterTypeEl.innerHTML === "") {
                filterTypeEl.innerHTML = `<option value="all">นักเรียนทั้งหมด</option><option value="classroom">ห้องเรียน</option><option value="date">วันที่บันทึก</option><option value="month">เดือน</option><option value="level">ระดับชั้น</option><option value="absence_continuous">การขาดเรียนต่อเนื่อง</option><option value="absence_noncontinuous">การขาดเรียนไม่ต่อเนื่อง</option><option value="late">การมาสาย</option>`;
            }
            const container = document.getElementById('summary-filter-input-container');
            const currentFilter = filterTypeEl.value; let inputHtml = '';
            if (currentFilter === 'classroom') { inputHtml = `<select id="summary-filter-value" class="form-control">${Array.from({length: 18}, (_, i) => `<option value="${i+1}">ห้อง ${i+1}</option>`).join('')}</select>`; }
            else if (currentFilter === 'date') { inputHtml = `<input type="date" id="summary-filter-value" class="form-control">`; }
            else if (currentFilter === 'month') { inputHtml = `<input type="month" id="summary-filter-value" class="form-control">`; }
            else if (currentFilter === 'level') { inputHtml = `<select id="summary-filter-value" class="form-control">${Array.from({length: 6}, (_, i) => `<option value="ม.${i+1}">ม.${i+1}</option>`).join('')}</select>`; }
            container.innerHTML = inputHtml;
        }

        function applySummaryFilters() {
            const type = document.getElementById('summary-filter-type').value;
            const value = document.getElementById('summary-filter-value')?.value || '';
            const filtered = allData.filter(row => {
                switch(type) {
                    case 'all': return true;
                    case 'classroom': return row.Classroom == value;
                    case 'date': return row.AttendanceDate === value;
                    case 'month': return row.AttendanceDate.startsWith(value); // YYYY-MM format matching
                    case 'level': return row.Level === value;
                    case 'absence_continuous': return row.AbsenceCategory === 'ขาดเรียนต่อเนื่อง(รอบ1เดือน)';
                    case 'absence_noncontinuous': return row.AbsenceCategory === 'ขาดเรียนไม่ต่อเนื่อง(รอบ1เดือน)';
                    case 'late': return row.AttendanceType === 'การมาสาย';
                    default: return true;
                }
            });
            renderSummaryTable(filtered);
        }

        function renderSummaryTable(data) {
            const table = document.getElementById('summary-table'), thead = table.querySelector('thead'), tbody = table.querySelector('tbody');
            thead.innerHTML = `<tr><th>ระดับชั้น</th><th>ห้อง</th><th>ชื่อ-สกุล</th><th>ชื่อเล่น</th><th>วันที่</th><th>ประเภท</th><th>รายละเอียด</th><th>ไฟล์แนบ</th><th>จัดการ</th></tr>`;
            tbody.innerHTML = '';
            if (data.length === 0) { tbody.innerHTML = `<tr><td colspan="9" style="text-align: center;">ไม่พบข้อมูล</td></tr>`; return; }
            data.forEach(row => {
                let detail = row.AbsenceDetailContinuous || row.AbsenceDetailNonContinuous || row.LateDetail || '-';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${row.Level}</td><td>${row.Classroom}</td><td>${row.FullName}</td><td>${row.Nickname || '-'}</td><td>${row.AttendanceDate}</td><td>${row.AttendanceType}</td><td>${detail}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" style="padding: 5px 8px;" onclick='showFilesModal(${JSON.stringify(row.ImagesJSON)}, "images")' ${!row.ImagesJSON || row.ImagesJSON.length === 0 ? 'disabled' : ''}><i class="fas fa-image"></i></button>
                        <button class="btn btn-primary btn-sm" style="padding: 5px 8px;" onclick='showFilesModal(${JSON.stringify(row.DocumentsJSON)}, "docs")' ${!row.DocumentsJSON || row.DocumentsJSON.length === 0 ? 'disabled' : ''}><i class="fas fa-file-alt"></i></button>
                    </td>
                    <td><button class="btn btn-secondary btn-sm" style="padding: 5px 8px;" onclick="editRecord(${row.RowID})"><i class="fas fa-edit"></i></button> <button class="btn btn-danger btn-sm" style="padding: 5px 8px;" onclick="deleteRecord(${row.RowID})"><i class="fas fa-trash"></i></button></td>`;
                tbody.appendChild(tr);
            });
        }
        
        // --- Page 4: Statistics Logic ---
        function setupStatsPageControls() {
            const select = document.getElementById('stats-filter');
            if (select.innerHTML !== "" && select.options.length > 1) return; // Already populated
            select.innerHTML = ''; // Clear previous options if any
            const options = {
                "all": "1. สรุปข้อมูลทั้งหมด", "level": "2. สรุปข้อมูลตามระดับชั้น", "month": "3. สรุปข้อมูลตามเดือน",
                "date": "4. สรุปข้อมูลตามวันที่", "type": "5. สรุปตามประเภทการมาเรียน", "top10": "6. สรุปนักเรียน Top 10"
            };
            Object.entries(options).forEach(([value, text]) => { select.innerHTML += `<option value="${value}">${text}</option>`; });
            handleStatsFilterChange(); // Initial chart render based on default selection
        }

        function handleStatsFilterChange() {
            const filter = document.getElementById('stats-filter').value;
            const optionsContainer = document.getElementById('stats-filter-options-container');
            let html = '';
            if (filter === 'level') { html = `<div class="form-group"><label>เลือกระดับชั้น:</label><select id="stats-level-select" class="form-control"></select></div>`; }
            else if (filter === 'month') { html = `<div class="form-group"><label>เลือกเดือน:</label><input type="month" id="stats-month-input" class="form-control"></div>`; }
            else if (filter === 'date') { html = `<div class="form-group"><label>เลือกวันที่:</label><input type="date" id="stats-date-input" class="form-control"></div>`; }
            else if (filter === 'type') { html = `<div class="form-group"><label>เลือกประเภท:</label><select id="stats-type-select" class="form-control"><option value="การขาดเรียน">การขาดเรียน</option><option value="การมาสาย">การมาสาย</option></select></div>`; }
            optionsContainer.innerHTML = html;
            
            if (filter === 'level') { const el = document.getElementById('stats-level-select'); for (let i=1; i<=6; i++) { el.innerHTML += `<option value="ม.${i}">ม.${i}</option>`; } el.addEventListener('change', renderAllCharts); }
            else if (['month', 'date', 'type'].includes(filter)) { optionsContainer.querySelector('input, select')?.addEventListener('change', renderAllCharts); }
            renderAllCharts();
        }

        function renderAllCharts() {
            const filter = document.getElementById('stats-filter').value;
            Object.values(charts).forEach(c => c.destroy()); charts = {};
            const wrapper = document.getElementById('charts-wrapper');
            wrapper.innerHTML = ''; // Clear previous charts
            
            let dataForCharts = allData;
            let chartTitlePrefix = '';

            if (filter === 'level') { const val = document.getElementById('stats-level-select')?.value; if(val){ dataForCharts = allData.filter(r => r.Level === val); chartTitlePrefix = `(ระดับชั้น ${val}) `; } }
            else if (filter === 'month') { const val = document.getElementById('stats-month-input')?.value; if (!val) { wrapper.innerHTML = '<p class="text-center">กรุณาเลือกเดือน</p>'; return; } dataForCharts = allData.filter(r => r.AttendanceDate.startsWith(val)); chartTitlePrefix = `(เดือน ${val}) `; }
            else if (filter === 'date') { const val = document.getElementById('stats-date-input')?.value; if (!val) { wrapper.innerHTML = '<p class="text-center">กรุณาเลือกวันที่</p>'; return; } dataForCharts = allData.filter(r => r.AttendanceDate === val); chartTitlePrefix = `(วันที่ ${val}) `; }
            else if (filter === 'type') { const val = document.getElementById('stats-type-select')?.value; dataForCharts = allData.filter(r => r.AttendanceType === val); chartTitlePrefix = `(ประเภท: ${val}) `; }
            
            if (dataForCharts.length === 0 && filter !== 'top10') { // top10 always uses allData
                 wrapper.innerHTML = '<p class="text-center" style="margin-top:20px;">ไม่พบข้อมูลสำหรับสร้างกราฟตามเงื่อนไข</p>'; return;
            }

            if (filter === 'all' || filter === 'level') {
                wrapper.innerHTML = `<div class="chart-grid"><div id="chart1-container"></div><div id="chart2-container"></div></div>`;
                createChart(dataForCharts, 'doughnut', 'chart1-container', `${chartTitlePrefix}ประเภทการมาเรียน`, 'AttendanceType');
                createChart(dataForCharts, 'bar', 'chart2-container', `${chartTitlePrefix}การติดตามผล (Top 5)`, 'FollowUpActions');
            } else if (filter === 'top10') {
                 wrapper.innerHTML = `<div id="chart1-container" style="max-height: 500px;"></div>`;
                 if (allData.length === 0) { wrapper.innerHTML = '<p class="text-center">ยังไม่มีข้อมูลนักเรียน</p>'; return; }
                 createChart(allData, 'bar', 'chart1-container', `นักเรียนที่ถูกบันทึกข้อมูลสูงสุด 10 อันดับ`, 'FullName');
            } else if (filter === 'month' || filter === 'date' || filter === 'type') {
                 wrapper.innerHTML = `<div class="chart-grid"><div id="chart1-container"></div><div id="chart2-container"></div></div>`;
                 let groupBy = 'AttendanceType';
                 if (filter === 'type') {
                     groupBy = document.getElementById('stats-type-select').value === 'การมาสาย' ? 'LateDetail' : 'AbsenceCategory';
                 }
                 createChart(dataForCharts, 'pie', 'chart1-container', `${chartTitlePrefix}${filter === 'type' ? 'รายละเอียด' : 'ประเภท'}`, groupBy);
                 createChart(dataForCharts, 'bar', 'chart2-container', `${chartTitlePrefix}การติดตามผล (Top 5)`, 'FollowUpActions');
            }
        }
        
        function createChart(data, type, containerId, title, groupBy) {
            const container = document.getElementById(containerId);
            if (!container) { console.error(`Container ${containerId} not found`); return; }
            container.innerHTML = `<canvas id="${containerId}-canvas"></canvas>`;
            const ctx = document.getElementById(`${containerId}-canvas`).getContext('2d');
            
            const counts = data.reduce((acc, row) => {
                let keys = row[groupBy];
                if (!keys || keys.length === 0 || keys === "[]") {
                    if (groupBy === 'FollowUpActions') { acc["ไม่ได้ระบุการติดตาม"] = (acc["ไม่ได้ระบุการติดตาม"] || 0) + 1; }
                    else if (groupBy !== 'FullName') { acc["ไม่ระบุ"] = (acc["ไม่ระบุ"] || 0) + 1; }
                    return acc;
                }
                if (groupBy === 'FollowUpActions' && Array.isArray(keys)) { keys.forEach(key => { if(key) acc[key] = (acc[key] || 0) + 1; }); }
                else if (typeof keys === 'string' && keys) { acc[keys] = (acc[keys] || 0) + 1; }
                return acc;
            }, {});

            let entries = Object.entries(counts).filter(([key, value]) => key && key !== "" && value > 0);
            if (groupBy === 'FullName' || groupBy === 'FollowUpActions') { entries = entries.sort(([,a],[,b]) => b-a).slice(0, (groupBy === 'FullName' ? 10 : 5)); }

            const labels = entries.map(e => e[0]);
            const chartData = entries.map(e => e[1]);
            
            if(labels.length === 0){
                container.innerHTML = `<p style="text-align:center; padding-top: 20px;">ไม่พบข้อมูลสำหรับกราฟ '${title}'</p>`;
                return;
            }

            charts[containerId] = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{ label: 'จำนวนครั้ง', data: chartData, backgroundColor: labels.map((_, i) => CHART_COLORS[i % CHART_COLORS.length]), borderWidth: 1, borderColor: type === 'doughnut' || type === 'pie' ? '#fff' : undefined }]
                },
                options: { responsive: true, maintainAspectRatio: type !== 'bar', plugins: { title: { display: true, text: title, font: { size: 16 } }, legend: { position: 'bottom', display: type !== 'bar' } } }
            });
        }
    </script>
</body>
</html>
