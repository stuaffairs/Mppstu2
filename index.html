<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกข้อมูลการมาโรงเรียน</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --primary-color: #4A148C; /* ม่วงเข้ม */
            --secondary-color: #CE93D8; /* ม่วงอ่อนใช้เป็น accent */
            --light-purple-bg: #f3e5f5; /* ม่วงอ่อนมากสำหรับพื้นหลังบางส่วน */
            --light-color: #FFFFFF;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --header-font-size: 2.2em;
            --subheader-font-size: 1.4em;
        }

        body {
            font-family: 'Sarabun', 'Kanit', sans-serif;
            margin: 0;
            background-color: #f9f8fc;
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1300px;
            margin: auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #6A1B9A 100%);
            color: var(--light-color);
            padding: 25px 20px;
            text-align: center;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            box-shadow: 0 6px 12px rgba(74, 20, 140, 0.2);
        }

            header h1 {
                font-size: var(--header-font-size);
                font-weight: 700;
                margin: 0;
                text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            }

            header h2 {
                font-size: var(--subheader-font-size);
                font-weight: 400;
                margin: 10px 0 0 0;
                opacity: 0.9;
            }

        nav {
            display: flex;
            justify-content: center;
            background-color: var(--light-color);
            padding: 5px 0;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            margin-top: 25px;
            border-radius: 12px;
            flex-wrap: wrap;
        }

        .nav-button {
            background-color: transparent;
            color: var(--primary-color);
            border: none;
            padding: 15px 20px;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 600;
            transition: background-color 0.3s, color 0.3s, border-bottom-color 0.3s;
            border-bottom: 4px solid transparent;
            letter-spacing: 0.5px;
        }

            .nav-button:hover, .nav-button.active {
                background-color: var(--light-purple-bg);
                color: #38006b;
                border-bottom-color: var(--primary-color);
            }

        .page {
            display: none;
            margin-top: 25px;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .page.active {
            display: block;
        }

        .card {
            background-color: var(--light-color);
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.07);
            padding: 30px;
            margin-bottom: 25px;
        }

            .card h3, .card h4 {
                color: var(--primary-color);
                border-bottom: 2px solid var(--secondary-color);
                padding-bottom: 12px;
                margin-top: 0;
                margin-bottom: 20px;
                font-size: 1.5em;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .card h4 {
                font-size: 1.2em;
                margin-bottom: 15px;
            }

        .form-group {
            margin-bottom: 22px;
        }

            .form-group label {
                display: block;
                font-weight: 600;
                margin-bottom: 8px;
                color: #444;
                font-size: 0.95em;
            }

        .form-control, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            box-sizing: border-box;
            transition: border-color 0.3s, box-shadow 0.3s;
            background-color: #fdfdfd;
        }

            .form-control:focus, select:focus, textarea:focus {
                border-color: var(--primary-color);
                outline: none;
                box-shadow: 0 0 0 3px rgba(74, 20, 140, 0.15);
            }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px 25px;
        }

        .btn {
            padding: 12px 28px;
            font-size: 1.05em;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            font-weight: 600;
            transition: all 0.25s ease-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }

            .btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), #7b1fa2);
            color: var(--light-color);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ab47bc, var(--secondary-color));
            color: var(--light-color);
        }

        .btn-success {
            background: linear-gradient(135deg, #43A047, #66BB6A);
            color: var(--light-color);
        }

        .btn-danger {
            background: linear-gradient(135deg, #E53935, #EF5350);
            color: var(--light-color);
        }

        .table-container {
            overflow-x: auto;
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
            font-size: 0.95em;
        }

        thead {
            background-color: var(--light-purple-bg);
        }

        th {
            font-weight: 600;
            color: var(--primary-color);
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }

        tbody tr:hover {
            background-color: #fdf5ff;
        }

        .hidden {
            display: none !important;
        }

        #recommendation-box {
            background-color: var(--light-purple-bg);
            border-left: 5px solid var(--primary-color);
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            font-size: 0.95em;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            background-color: #fdfdfd;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #eee;
        }

            .checkbox-item input[type="checkbox"] {
                margin-right: 12px;
                width: 18px;
                height: 18px;
                accent-color: var(--primary-color);
            }

        .search-filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
            padding: 20px;
            background-color: var(--light-purple-bg);
            border-radius: 8px;
            margin-bottom: 20px;
        }

            .search-filters .form-group {
                margin-bottom: 0;
            }

        .swal2-html-container {
            text-align: left !important;
            font-size: 1em !important;
            max-height: 70vh;
            overflow-y: auto;
        }

        .swal2-input, .swal2-select, .swal2-textarea {
            font-size: 1em !important;
            border-radius: 6px !important;
        }

        .swal2-actions button {
            font-size: 1em !important;
            padding: 10px 20px !important;
            margin: 5px !important;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        #individual-student-info-display img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            float: left;
            margin-right: 15px;
            border: 2px solid var(--secondary-color);
            object-fit: cover;
        }

        #individual-student-info-display p {
            margin-bottom: 5px;
            line-height: 1.5;
        }

        #individual-student-info-display div:not(:has(img)) {
            overflow: hidden;
        }

        .clear-float {
            clear: both;
        }

        @media (min-width: 992px) {
            .chart-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .nav-button {
                flex-grow: 1;
                text-align: center;
                font-size: 0.95em;
                padding: 12px 15px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            header h1 {
                font-size: 1.8em;
            }

            header h2 {
                font-size: 1.2em;
            }

            .card h3, .card h4 {
                font-size: 1.3em;
            }

            .btn {
                padding: 10px 20px;
                font-size: 0.95em;
            }

            #individual-student-info-display img {
                float: none;
                display: block;
                margin: 0 auto 10px auto;
            }
        }
    </style>
</head>
<body>

    <header>
        <h1><i class="fas fa-user-check"></i> บันทึกข้อมูลการมาโรงเรียนของนักเรียน</h1>
        <h2>โรงเรียนมาบตาพุดพันพิทยาคาร</h2>
    </header>

    <div class="container">
            <nav>
        <button class="nav-button active" data-page="page-form"><i class="fas fa-file-alt"></i> บันทึกข้อมูลนักเรียน</button>
        <button class="nav-button" data-page="page-individual"><i class="fas fa-user-search"></i> ข้อมูลรายบุคคล</button>
        <button class="nav-button" data-page="page-summary"><i class="fas fa-list-alt"></i> สรุปข้อมูลรวม</button>
        <button class="nav-button" data-page="page-stats"><i class="fas fa-chart-bar"></i> สถิติ</button>
            </nav>

        <div id="page-form" class="page active">
            <form id="attendanceForm">
                <div class="card">
                    <h3><i class="fas fa-user-graduate"></i> ข้อมูลนักเรียน</h3>
                    <div class="form-grid">
                        <div class="form-group"><label for="level">ระดับชั้น</label><select id="level" class="form-control" required></select></div>
                        <div class="form-group"><label for="classroom">ห้องเรียน</label><select id="classroom" class="form-control" required></select></div>
                        <div class="form-group"><label for="studentNumber">เลขที่</label><select id="studentNumber" class="form-control" required></select></div>
                        <div class="form-group"><label for="studentId">รหัสประจำตัวนักเรียน</label><input type="text" id="studentId" class="form-control" required></div>
                        <div class="form-group"><label for="fullName">ชื่อ-สกุล</label><input type="text" id="fullName" class="form-control" required></div>
                        <div class="form-group"><label for="nickname">ชื่อเล่น</label><input type="text" id="nickname" class="form-control"></div>
                    </div>
                    <div class="form-group" style="margin-top: 20px;">
                        <label for="profilePicFile">รูปประจำตัวนักเรียน (1 รูป)</label>
                        <input type="file" id="profilePicFile" name="profilePicFile" class="form-control" accept="image/*">
                    </div>
                </div>

                <div class="card">
                    <h3><i class="fas fa-calendar-check"></i> ข้อมูลการมาโรงเรียน</h3>
                    <div class="form-grid">
                        <div class="form-group"><label for="attendanceDate">วันที่บันทึก</label><input type="date" id="attendanceDate" class="form-control" required></div>
                        <div class="form-group"><label for="attendanceType">ประเภท</label><select id="attendanceType" class="form-control" required><option value="">-- เลือกประเภท --</option><option value="การขาดเรียน">การขาดเรียน</option><option value="การมาสาย">การมาสาย</option></select></div>
                        <div class="form-group"><label for="attendanceOccurrence">ครั้งที่ (สะสม)</label><select id="attendanceOccurrence" class="form-control" required></select></div>
                    </div>

                    <div id="absence-options" class="hidden">
                        <div class="form-group"><label for="absenceCategory">หมวดหมู่การขาดเรียน</label><select id="absenceCategory" class="form-control"><option value="">-- เลือกหมวดหมู่ --</option><option value="ขาดเรียนต่อเนื่อง(รอบ1เดือน)">ขาดเรียนต่อเนื่อง(รอบ1เดือน)</option><option value="ขาดเรียนไม่ต่อเนื่อง(รอบ1เดือน)">ขาดเรียนไม่ต่อเนื่อง(รอบ1เดือน)</option></select></div>
                        <div id="absence-continuous-options" class="form-group hidden"><label for="absenceDetailContinuous">รายละเอียดการขาดต่อเนื่อง</label><select id="absenceDetailContinuous" class="form-control"><option value="">-- เลือก --</option><option value="ขาดติดต่อกัน เกิน 3 วัน">ขาดติดต่อกัน เกิน 3 วัน</option><option value="ขาดติดต่อกันเกิน 5 วัน">ขาดติดต่อกันเกิน 5 วัน</option><option value="ขาดติดต่อกันเกิน 7 วัน">ขาดติดต่อกันเกิน 7 วัน</option><option value="ขาดติดต่อกันเกิน 9 วัน">ขาดติดต่อกันเกิน 9 วัน</option></select></div>
                        <div id="absence-noncontinuous-options" class="form-group hidden"><label for="absenceDetailNonContinuous">รายละเอียดการขาดไม่ต่อเนื่อง</label><select id="absenceDetailNonContinuous" class="form-control"><option value="">-- เลือก --</option><option value="ขาดเรียน 5 วันไม่ต่อเนื่อง">ขาดเรียน 5 วันไม่ต่อเนื่อง</option><option value="ขาดเรียน 7 วันไม่ต่อเนื่อง">ขาดเรียน 7 วันไม่ต่อเนื่อง</option><option value="ขาดเรียน 9 วันไม่ต่อเนื่อง">ขาดเรียน 9 วันไม่ต่อเนื่อง</option></select></div>
                    </div>
                    <div id="late-options" class="form-group hidden">
                        <label for="lateDetail">รายละเอียดการมาสาย</label><select id="lateDetail" class="form-control"><option value="">-- เลือก --</option><option value="มาสาย 5 ครั้ง">มาสาย 5 ครั้ง</option></select>
                    </div>
                </div>

                <div class="card">
                    <h3><i class="fas fa-paperclip"></i> แนบไฟล์ประกอบการบันทึก</h3>
                    <div class="form-grid">
                        <div class="form-group"><label for="docFile">เอกสาร (1 ไฟล์)</label><input type="file" id="docFile" name="docFile" class="form-control" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx"></div>
                        <div class="form-group"><label for="imgFile">รูปภาพ (1 ไฟล์)</label><input type="file" id="imgFile" name="imgFile" class="form-control" accept="image/*"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>ผลการติดตาม (เลือกได้หลายข้อ)</label>
                    <div id="followUpActions" class="checkbox-grid"></div>
                </div>
                <div class="form-group">
                    <label for="followUpStatus">สถานะการติดตาม</label>
                    <select id="followUpStatus" class="form-control" required>
                        <option value="ระหว่างดำเนินการ">ระหว่างดำเนินการ</option>
                        <option value="ดำเนินการเรียบร้อย">ดำเนินการเรียบร้อย</option>
                    </select>
                </div>
                <div class="form-group"><label for="notes">หมายเหตุ</label><textarea id="notes" class="form-control" rows="3" placeholder="รายละเอียด..."></textarea></div>
                <div id="recommendation-box" class="hidden"></div>
                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> บันทึกข้อมูล</button>
            </form>
        </div>

        <div id="page-individual" class="page">
            <div class="card">
                <h3><i class="fas fa-user-cog"></i> ค้นหาและจัดการข้อมูลนักเรียนรายบุคคล</h3>
                <div class="search-filters">
                    <div class="form-group">
                        <label for="individual-search-type">ค้นหาจาก:</label>
                        <select id="individual-search-type" class="form-control">
                            <option value="FullName">ชื่อ-สกุล</option>
                            <option value="Nickname">ชื่อเล่น</option>
                            <option value="StudentID">รหัสประจำตัว</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="individual-search-keyword">คำค้นหา:</label>
                        <input type="text" id="individual-search-keyword" class="form-control" placeholder="ป้อนคำค้นหา...">
                    </div>
                    <button id="individual-search-btn" class="btn btn-secondary"><i class="fas fa-search"></i> ค้นหา</button>
                    <a href="https://docs.google.com/spreadsheets/d/1YEqS1zEf-ej7lfqLIpej6j2YXbAgCES3VC_2ODH721Y" target="_blank" class="btn btn-success"><i class="fab fa-google-drive"></i> เปิด Google Sheet</a>
                </div>
                <div id="individual-student-info-display" class="card hidden" style="background-color: var(--light-purple-bg);">
                    <h4 id="student-info-header">ข้อมูลนักเรียน:</h4> <div id="student-info-content"></div>
                </div>
            </div>
            <div class="table-container">
                <table id="individual-table">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="page-summary" class="page">
        <div class="card">
            <h3><i class="fas fa-clipboard-list"></i> สรุปข้อมูลการมาโรงเรียนทั้งหมด</h3>
            <div class="search-filters" id="summary-filters-container">
                <div class="form-group">
                    <label for="summary-filter-type">กรองข้อมูลโดย:</label>
                    <select id="summary-filter-type" class="form-control"></select>
                </div>
                <div id="summary-filter-input-container" class="form-group"></div>
                <button id="summary-filter-btn" class="btn btn-secondary"><i class="fas fa-filter"></i> กรองข้อมูล</button>
            </div>
            <a href="https://docs.google.com/spreadsheets/d/1YEqS1zEf-ej7lfqLIpej6j2YXbAgCES3VC_2ODH721Y" target="_blank" class="btn btn-success" style="margin-top: 10px;"><i class="fab fa-google-drive"></i> เปิด Google Sheet</a>
            <div class="table-container">
                <table id="summary-table">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="page-stats" class="page">
        <div class="card">
            <h3><i class="fas fa-chart-line"></i> สถิติและข้อมูลเชิงลึก</h3>
            <div class="form-group">
                <label for="stats-filter">เลือกรูปแบบการแสดงผลสถิติ</label>
                <select id="stats-filter" class="form-control"></select>
            </div>
            <div id="stats-filter-options-container" class="form-grid"></div>
            <div id="charts-wrapper" style="margin-top: 20px;"></div>
        </div>
    </div>


    <script>
      const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyzqfq2uEXoutaqjtdW-KuYW7BmqcFH1qXoMAz3g7E_aTminUc7zjKIKDFV0DROV617xQ/exec";
        let allData = [];
let charts = {};
const followUpOptions = [
    "ครูที่ปรึกษาติดตาม", "ปค.6 ติดตามการขาดเรียน", "ปค.6/1 รายงานผลการติดตามขาดเรียน", "ปค.5 ติดตามการมาสาย",
    "ปค.5/1 รายงานติดตามการมาสาย", "ปค.3 เชิญผู้ปกครอง", "แขวนลอย", "ทัณฑ์บน", "บันทึกข้อตกลง", "พฐ.17 (ม.ต้น)", "อื่น ๆ"
];
const recommendations = {
    "ขาดติดต่อกัน เกิน 3 วัน": "ติดตามและบันทึกแบบ ปค.6", "ขาดติดต่อกันเกิน 5 วัน": "ติดตามและบันทึกแบบ ปค.6 และ ปค.6/1",
    "ขาดติดต่อกันเกิน 7 วัน": "ติดตามและบันทึกแบบ ปค.6 และ ปค.6/1 (ม.ต้น พฐ.17)", "ขาดติดต่อกันเกิน 9 วัน": "ส่งข้อมูลกับวิชาการเพื่อแขวนลอย/ปรับเปลี่ยนสภาพแวดล้อม",
    "ขาดเรียน 5 วันไม่ต่อเนื่อง": "ติดตามและบันทึกแบบ ปค.6", "ขาดเรียน 7 วันไม่ต่อเนื่อง": "ติดตามและบันทึกแบบ ปค.6 และ ปค.6/1 (ม.ต้น พฐ.17)",
    "ขาดเรียน 9 วันไม่ต่อเนื่อง": "ส่งข้อมูลกับวิชาการเพื่อแขวนลอย/ปรับเปลี่ยนสภาพแวดล้อม", "มาสาย 5 ครั้ง": "ติดตามและบันทึกแบบ ปค.5 เชิญประชุมผปค. และ รายงาน ปค.5/1 (หากบันทึกครบ 3 ครั้ง ให้ทำทัณฑ์บน)"
};
const CHART_COLORS = ['#4A148C', '#7B1FA2', '#9C27B0', '#BA68C8', '#CE93D8', '#6A1B9A', '#AB47BC', '#E1BEE7', '#8E24AA', '#673AB7', '#512DA8', '#D1C4E9'];

// --- Initialization ---
document.addEventListener('DOMContentLoaded', () => {
    populateStaticDropdowns();
    setupEventListeners();
    fetchAllData().then(() => {
        if (allData && allData.length > 0) {
            applySummaryFilters();
            setupStatsPageControls();
        } else {
            const summaryTbody = document.getElementById('summary-table')?.querySelector('tbody');
            if (summaryTbody) summaryTbody.innerHTML = `<tr><td colspan="11" style="text-align: center;">ไม่พบข้อมูล หรือกำลังรอการโหลด</td></tr>`;
            const chartsWrapper = document.getElementById('charts-wrapper');
            if (chartsWrapper) chartsWrapper.innerHTML = `<p class="text-center">ไม่พบข้อมูลสำหรับสร้างกราฟ</p>`;
        }
    }).catch(error => {
        Swal.fire('เกิดข้อผิดพลาดในการเริ่มต้น', 'ไม่สามารถโหลดข้อมูลเริ่มต้นได้: ' + error.message, 'error');
    });
});

function populateStaticDropdowns() {
    const populate = (elId, start, end, formatFn, addEmptyOption = false) => {
        const el = document.getElementById(elId);
        if (!el) return;
        el.innerHTML = addEmptyOption ? '<option value="">-- เลือก --</option>' : '';
        for (let i = start; i <= end; i++) el.innerHTML += formatFn(i);
    };
    populate('level', 1, 6, i => `<option value="ม.${i}">ม.${i}</option>`);
    populate('classroom', 1, 18, i => `<option value="${i}">ห้อง ${i}</option>`);
    populate('studentNumber', 1, 50, i => `<option value="${i}">${i}</option>`);
    populate('attendanceOccurrence', 1, 20, i => `<option value="ครั้งที่ ${i}">ครั้งที่ ${i}</option>`);

    const followUpContainer = document.getElementById('followUpActions');
    if (followUpContainer) {
        followUpContainer.innerHTML = '';
        followUpOptions.forEach(opt => {
            const id = `follow-${opt.replace(/[^a-zA-Z0-9ก-๙]/g, "")}`;
            followUpContainer.innerHTML += `
                <div class="checkbox-item">
                    <input type="checkbox" id="${id}" name="followUp" value="${opt}">
                    <label for="${id}">${opt}</label>
                </div>`;
        });
    }
    const attendanceDateEl = document.getElementById('attendanceDate');
    if (attendanceDateEl) attendanceDateEl.valueAsDate = new Date();
    setupSummaryPageFilters();
}

function setupEventListeners() {
    document.querySelectorAll('.nav-button').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const pageId = e.currentTarget.dataset.page;
            document.querySelector('.nav-button.active')?.classList.remove('active');
            e.currentTarget.classList.add('active');
            showPage(pageId);
        });
    });

    document.getElementById('attendanceForm')?.addEventListener('submit', handleFormSubmit);
    document.getElementById('attendanceType')?.addEventListener('change', handleAttendanceTypeChange);
    document.getElementById('absenceCategory')?.addEventListener('change', handleAbsenceCategoryChange);
    document.getElementById('absenceDetailContinuous')?.addEventListener('change', (e) => updateRecommendations(e.target.value));
    document.getElementById('absenceDetailNonContinuous')?.addEventListener('change', (e) => updateRecommendations(e.target.value));
    document.getElementById('lateDetail')?.addEventListener('change', (e) => updateRecommendations(e.target.value));
    document.getElementById('individual-search-btn')?.addEventListener('click', renderIndividualTable);
    document.getElementById('summary-filter-btn')?.addEventListener('click', applySummaryFilters);
    document.getElementById('summary-filter-type')?.addEventListener('change', setupSummaryPageFilters);
    document.getElementById('stats-filter')?.addEventListener('change', handleStatsFilterChange);
}

function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    const newPage = document.getElementById(pageId);
    if (newPage) {
        newPage.classList.add('active');
        if (pageId === 'page-summary') applySummaryFilters();
        if (pageId === 'page-stats') handleStatsFilterChange();
    }
}

async function fetchAllData() {
    Swal.fire({ title: 'กำลังโหลดข้อมูล...', imageUrl: 'https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/0.16.1/images/loader-large.gif', imageWidth: 100, imageHeight: 100, showConfirmButton: false, allowOutsideClick: false });
    try {
        const response = await fetch(`${SCRIPT_URL}?action=read`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const jsonData = await response.json();
        if (!Array.isArray(jsonData)) throw new Error("รูปแบบข้อมูลที่ได้รับไม่ถูกต้อง");
        
        allData = jsonData;
        allData.sort((a, b) => new Date(b.AttendanceDate) - new Date(a.AttendanceDate));
        Swal.close();
    } catch (error) {
        Swal.fire('ผิดพลาด!', 'ไม่สามารถดึงข้อมูลได้: ' + error.message, 'error');
        allData = [];
    }
}

function handleAttendanceTypeChange(e) {
    const type = e.target.value;
    document.getElementById('absence-options').classList.toggle('hidden', type !== 'การขาดเรียน');
    document.getElementById('late-options').classList.toggle('hidden', type !== 'การมาสาย');
    document.getElementById('absenceCategory').value = "";
    handleAbsenceCategoryChange({ target: { value: "" } });
    updateRecommendations("");
}

function handleAbsenceCategoryChange(e) {
    const category = e.target.value;
    document.getElementById('absence-continuous-options').classList.toggle('hidden', category !== 'ขาดเรียนต่อเนื่อง(รอบ1เดือน)');
    document.getElementById('absence-noncontinuous-options').classList.toggle('hidden', category !== 'ขาดเรียนไม่ต่อเนื่อง(รอบ1เดือน)');
    document.getElementById('absenceDetailContinuous').value = "";
    document.getElementById('absenceDetailNonContinuous').value = "";
    updateRecommendations("");
}

function updateRecommendations(key) {
    const box = document.getElementById('recommendation-box');
    if (key && recommendations[key]) {
        box.innerHTML = `<strong><i class="fas fa-info-circle"></i> คำแนะนำ:</strong> ${recommendations[key]}`;
        box.classList.remove('hidden');
    } else {
        box.classList.add('hidden');
    }
}

async function handleFormSubmit(e) {
    e.preventDefault();
    Swal.fire({ title: 'กำลังบันทึกข้อมูล...', text: 'กรุณารอสักครู่', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
    
    const form = e.target;
    const profilePicData = await fileToBase64(form.profilePicFile.files[0]);
    const documentData = await fileToBase64(form.docFile.files[0]);
    const imageData = await fileToBase64(form.imgFile.files[0]);
    const selectedFollowUps = Array.from(form.querySelectorAll('input[name="followUp"]:checked')).map(cb => cb.value);

    const params = new URLSearchParams({
        action: 'create',
        level: form.level.value, classroom: form.classroom.value, studentNumber: form.studentNumber.value,
        studentId: form.studentId.value, fullName: form.fullName.value, nickname: form.nickname.value,
        profilePicData: profilePicData ? JSON.stringify(profilePicData) : null,
        attendanceDate: form.attendanceDate.value, attendanceType: form.attendanceType.value,
        attendanceOccurrence: form.attendanceOccurrence.value,
        absenceCategory: form.attendanceType.value === 'การขาดเรียน' ? form.absenceCategory.value : "",
        absenceDetailContinuous: (form.attendanceType.value === 'การขาดเรียน' && form.absenceCategory.value === 'ขาดเรียนต่อเนื่อง(รอบ1เดือน)') ? form.absenceDetailContinuous.value : "",
        absenceDetailNonContinuous: (form.attendanceType.value === 'การขาดเรียน' && form.absenceCategory.value === 'ขาดเรียนไม่ต่อเนื่อง(รอบ1เดือน)') ? form.absenceDetailNonContinuous.value : "",
        lateDetail: form.attendanceType.value === 'การมาสาย' ? form.lateDetail.value : "",
        followUpActions: JSON.stringify(selectedFollowUps),
        followUpStatus: form.followUpStatus.value,
        notes: form.notes.value,
        documentData: documentData ? JSON.stringify(documentData) : null,
        imageData: imageData ? JSON.stringify(imageData) : null
    });

    try {
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: params });
        const result = await res.json();
        if (result.status === 'success') {
            Swal.fire('สำเร็จ!', result.message || 'บันทึกข้อมูลเรียบร้อย', 'success');
            form.reset();
            document.getElementById('attendanceDate').valueAsDate = new Date();
            handleAttendanceTypeChange({ target: { value: "" } });
            await fetchAllData();
            applySummaryFilters();
            handleStatsFilterChange();
        } else { throw new Error(result.message || 'Error saving data'); }
    } catch (error) {
        Swal.fire('ผิดพลาด!', 'เกิดข้อผิดพลาด: ' + error.message, 'error');
    }
}

async function editRecord(rowId) {
    const rowData = allData.find(r => r.RowID == rowId);
    if (!rowData) { Swal.fire('ผิดพลาด', 'ไม่พบข้อมูล', 'error'); return; }

    const genOptions = (start, end, formatFn, selectedVal) => Array.from({ length: end - start + 1 }, (_, i) => i + start).map(val => `<option value="${formatFn(val).value}" ${formatFn(val).value == selectedVal ? 'selected' : ''}>${formatFn(val).text}</option>`).join('');
    const genSimpleOptions = (arr, selectedVal, addEmpty = true) => (addEmpty ? '<option value="">-- เลือก --</option>' : '') + arr.map(val => `<option value="${val}" ${val == selectedVal ? 'selected' : ''}>${val}</option>`).join('');

    const modalHtml = `
        <div style="text-align:left;">
            <div class="card" style="box-shadow: none; padding:0; margin-bottom:15px;">
                <h4><i class="fas fa-user-graduate"></i> ข้อมูลนักเรียน (แก้ไขได้)</h4>
                <div class="form-grid">
                    <div class="form-group"><label>ระดับชั้น</label><select id="swal-level" class="form-control">${genOptions(1, 6, i => ({value: `ม.${i}`, text: `ม.${i}`}), rowData.Level)}</select></div>
                    <div class="form-group"><label>ห้อง</label><select id="swal-classroom" class="form-control">${genOptions(1, 18, i => ({value: i, text: `ห้อง ${i}`}), rowData.Classroom)}</select></div>
                    <div class="form-group"><label>เลขที่</label><select id="swal-studentNumber" class="form-control">${genOptions(1, 50, i => ({value: i, text: i}), rowData.StudentNumber)}</select></div>
                    <div class="form-group"><label>รหัสนักเรียน</label><input id="swal-studentId" class="form-control" value="${rowData.StudentID}"></div>
                    <div class="form-group"><label>ชื่อ-สกุล</label><input id="swal-fullName" class="form-control" value="${rowData.FullName}"></div>
                    <div class="form-group"><label>ชื่อเล่น</label><input id="swal-nickname" class="form-control" value="${rowData.Nickname || ''}"></div>
                </div>
            </div> <hr>
            <h4><i class="fas fa-calendar-check"></i> แก้ไขข้อมูลการมาโรงเรียน</h4>
            <div class="form-grid">
                <div class="form-group"><label>วันที่บันทึก</label><input id="swal-attendanceDate" type="date" class="form-control" value="${rowData.AttendanceDate}"></div>
                <div class="form-group"><label>ประเภท</label><select id="swal-attendanceType" class="form-control">${genSimpleOptions(['การขาดเรียน', 'การมาสาย'], rowData.AttendanceType, false)}</select></div>
                <div class="form-group"><label>ครั้งที่ (สะสม)</label><select id="swal-attendanceOccurrence" class="form-control">${genOptions(1, 20, i => ({value: `ครั้งที่ ${i}`, text: `ครั้งที่ ${i}`}), rowData.AttendanceOccurrence)}</select></div>
            </div>
            <div id="swal-absence-options" class="${rowData.AttendanceType === 'การขาดเรียน' ? '' : 'hidden'}">
                <div class="form-group"><label for="swal-absenceCategory">หมวดหมู่การขาดเรียน</label><select id="swal-absenceCategory" class="form-control">${genSimpleOptions(['ขาดเรียนต่อเนื่อง(รอบ1เดือน)','ขาดเรียนไม่ต่อเนื่อง(รอบ1เดือน)'], rowData.AbsenceCategory)}</select></div>
                <div id="swal-absence-continuous-options" class="form-group ${rowData.AbsenceCategory === 'ขาดเรียนต่อเนื่อง(รอบ1เดือน)' && rowData.AttendanceType === 'การขาดเรียน' ? '' : 'hidden'}"><label for="swal-absenceDetailContinuous">รายละเอียดการขาดต่อเนื่อง</label><select id="swال-absenceDetailContinuous" class="form-control">${genSimpleOptions(["ขาดติดต่อกัน เกิน 3 วัน", "ขาดติดต่อกันเกิน 5 วัน", "ขาดติดต่อกันเกิน 7 วัน", "ขาดติดต่อกันเกิน 9 วัน"], rowData.AbsenceDetailContinuous)}</select></div>
                <div id="swal-absence-noncontinuous-options" class="form-group ${rowData.AbsenceCategory === 'ขาดเรียนไม่ต่อเนื่อง(รอบ1เดือน)' && rowData.AttendanceType === 'การขาดเรียน' ? '' : 'hidden'}"><label for="swal-absenceDetailNonContinuous">รายละเอียดการขาดไม่ต่อเนื่อง</label><select id="swal-absenceDetailNonContinuous" class="form-control">${genSimpleOptions(["ขาดเรียน 5 วันไม่ต่อเนื่อง", "ขาดเรียน 7 วันไม่ต่อเนื่อง", "ขาดเรียน 9 วันไม่ต่อเนื่อง"], rowData.AbsenceDetailNonContinuous)}</select></div>
            </div>
            <div id="swal-late-options" class="form-group ${rowData.AttendanceType === 'การมาสาย' ? '' : 'hidden'}">
                <label for="swal-lateDetail">รายละเอียดการมาสาย</label><select id="swal-lateDetail" class="form-control">${genSimpleOptions(["มาสาย 5 ครั้ง"], rowData.LateDetail)}</select>
            </div>
            <div class="form-group"><label>ผลการติดตาม</label><div id="swal-followUpActions" class="checkbox-grid"></div></div>
            <div class="form-group"><label for="swal-followUpStatus">สถานะการติดตาม</label><select id="swal-followUpStatus" class="form-control">${genSimpleOptions(['ระหว่างดำเนินการ', 'ดำเนินการเรียบร้อย'], rowData.FollowUpStatus, false)}</select></div>
            <div class="form-group"><label>หมายเหตุ</label><textarea id="swal-notes" class="form-control" rows="3">${rowData.Notes || ''}</textarea></div>
        </div>`;

    const { value: formValues } = await Swal.fire({
        title: 'แก้ไขข้อมูล', html: modalHtml, width: '90%', showCancelButton: true,
        confirmButtonText: '<i class="fas fa-save"></i> บันทึกการแก้ไข', cancelButtonText: 'ยกเลิก',
        didOpen: () => {
            const swalAttendanceTypeEl = document.getElementById('swal-attendanceType');
            swalAttendanceTypeEl.value = rowData.AttendanceType;
            const swalAbsenceOptionsEl = document.getElementById('swal-absence-options');
            const swalLateOptionsEl = document.getElementById('swal-late-options');
            swalAbsenceOptionsEl.classList.toggle('hidden', rowData.AttendanceType !== 'การขาดเรียน');
            swalLateOptionsEl.classList.toggle('hidden', rowData.AttendanceType !== 'การมาสาย');

            swalAttendanceTypeEl.addEventListener('change', (e) => {
                swalAbsenceOptionsEl.classList.toggle('hidden', e.target.value !== 'การขาดเรียน');
                swalLateOptionsEl.classList.toggle('hidden', e.target.value !== 'การมาสาย');
            });

            const swalAbsenceCategoryEl = document.getElementById('swal-absenceCategory');
            swalAbsenceCategoryEl.value = rowData.AbsenceCategory || "";
            const swalAbsenceContinuousEl = document.getElementById('swal-absence-continuous-options');
            const swalAbsenceNonContinuousEl = document.getElementById('swal-absence-noncontinuous-options');
            swalAbsenceContinuousEl.classList.toggle('hidden', !(rowData.AttendanceType === 'การขาดเรียน' && rowData.AbsenceCategory === 'ขาดเรียนต่อเนื่อง(รอบ1เดือน)'));
            swalAbsenceNonContinuousEl.classList.toggle('hidden', !(rowData.AttendanceType === 'การขาดเรียน' && rowData.AbsenceCategory === 'ขาดเรียนไม่ต่อเนื่อง(รอบ1เดือน)'));

            swalAbsenceCategoryEl.addEventListener('change', (e) => {
                swalAbsenceContinuousEl.classList.toggle('hidden', e.target.value !== 'ขาดเรียนต่อเนื่อง(รอบ1เดือน)');
                swalAbsenceNonContinuousEl.classList.toggle('hidden', e.target.value !== 'ขาดเรียนไม่ต่อเนื่อง(รอบ1เดือน)');
            });
            
            document.getElementById('swal-absenceDetailContinuous').value = rowData.AbsenceDetailContinuous || "";
            document.getElementById('swal-absenceDetailNonContinuous').value = rowData.AbsenceDetailNonContinuous || "";
            document.getElementById('swal-lateDetail').value = rowData.LateDetail || "";
            document.getElementById('swal-followUpStatus').value = rowData.FollowUpStatus || "ระหว่างดำเนินการ";
            
            const swalFollowUpContainer = document.getElementById('swal-followUpActions');
            swalFollowUpContainer.innerHTML = '';
            const currentFollowUps = Array.isArray(rowData.FollowUpActions) ? rowData.FollowUpActions : [];
            followUpOptions.forEach(opt => {
                const checked = currentFollowUps.includes(opt) ? 'checked' : '';
                const id = `swal-follow-${opt.replace(/[^a-zA-Z0-9ก-๙]/g, "")}`;
                swalFollowUpContainer.innerHTML += `<div class="checkbox-item"><input type="checkbox" id="${id}" name="swalFollowUp" value="${opt}" ${checked}><label for="${id}">${opt}</label></div>`;
            });
        },
        preConfirm: () => {
            const selectedFollowUps = Array.from(document.querySelectorAll('input[name="swalFollowUp"]:checked')).map(cb => cb.value);
            return {
                level: document.getElementById('swal-level').value,
                classroom: document.getElementById('swal-classroom').value,
                studentNumber: document.getElementById('swal-studentNumber').value,
                studentId: document.getElementById('swal-studentId').value,
                fullName: document.getElementById('swal-fullName').value,
                nickname: document.getElementById('swal-nickname').value,
                attendanceDate: document.getElementById('swal-attendanceDate').value,
                attendanceType: document.getElementById('swal-attendanceType').value,
                attendanceOccurrence: document.getElementById('swal-attendanceOccurrence').value,
                absenceCategory: document.getElementById('swal-attendanceType').value === 'การขาดเรียน' ? document.getElementById('swal-absenceCategory').value : "",
                absenceDetailContinuous: (document.getElementById('swal-attendanceType').value === 'การขาดเรียน' && document.getElementById('swal-absenceCategory').value === 'ขาดเรียนต่อเนื่อง(รอบ1เดือน)') ? document.getElementById('swal-absenceDetailContinuous').value : "",
                absenceDetailNonContinuous: (document.getElementById('swal-attendanceType').value === 'การขาดเรียน' && document.getElementById('swal-absenceCategory').value === 'ขาดเรียนไม่ต่อเนื่อง(รอบ1เดือน)') ? document.getElementById('swal-absenceDetailNonContinuous').value : "",
                lateDetail: document.getElementById('swal-attendanceType').value === 'การมาสาย' ? document.getElementById('swal-lateDetail').value : "",
                followUpActions: JSON.stringify(selectedFollowUps),
                followUpStatus: document.getElementById('swal-followUpStatus').value,
                notes: document.getElementById('swal-notes').value
            }
        }
    });

    if (formValues) {
        Swal.fire({ title: 'กำลังอัปเดต...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        const params = new URLSearchParams({ action: 'update', rowId, ...formValues });
        try {
            const res = await fetch(SCRIPT_URL, { method: 'POST', body: params });
            const result = await res.json();
            if (result.status === 'success') {
                Swal.fire('สำเร็จ!', result.message, 'success');
                await fetchAllData();
                const activePageId = document.querySelector('.page.active')?.id;
                if (activePageId === 'page-individual') renderIndividualTable();
                else if (activePageId === 'page-summary') applySummaryFilters();
                if (activePageId === 'page-stats') handleStatsFilterChange();
            } else { throw new Error(result.message); }
        } catch (error) { Swal.fire('ผิดพลาด!', "เกิดข้อผิดพลาด: " + error.message, 'error'); }
    }
}
    </script>
</body>
</html>
